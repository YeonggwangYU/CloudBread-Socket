{"version":3,"sources":["webpack:///webpack/bootstrap 64006460e606a63c5717","webpack:///./src/config.js","webpack:///./src/core/redisClient.js","webpack:///./src/server.js","webpack:///external \"babel-polyfill\"","webpack:///external \"cors\"","webpack:///external \"express\"","webpack:///external \"http\"","webpack:///external \"redis\"","webpack:///external \"socket.io\"","webpack:///external \"socket.io-redis\""],"names":["process","env","REDIS_HOST","REDIS_PORT","REDIS_AUTH_KEY","getRedisItem","canRedis","pubClient","host","port","auth_pass","subClient","return_buffers","redisClient","id","Promise","resolve","reject","get","error","res","app","server","require","Server","listen","PORT","address","console","log","use","req","status","send","channels","users","io","adapter","on","socket","client","route","callback","emit","type","message","token","username","userInfo","user","link","indexOf","allUsers","channel","push","join","broadcast","to","splice","leave","content","author","sockets","forEach"],"mappings":"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","file":"server.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 64006460e606a63c5717","export const {\r\n  REDIS_HOST,\r\n  REDIS_PORT,\r\n  REDIS_AUTH_KEY,\r\n} = process.env;\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/config.js","import { REDIS_HOST, REDIS_AUTH_KEY, REDIS_PORT } from 'config';\r\nimport { createClient as createRedisClient } from 'redis';\r\n\r\nexport const canRedis = REDIS_HOST;\r\n\r\nexport const pubClient = canRedis ? createRedisClient({\r\n  host: REDIS_HOST,\r\n  port: REDIS_PORT,\r\n  auth_pass: REDIS_AUTH_KEY,\r\n}) : null;\r\n\r\nexport const subClient = canRedis ? createRedisClient({\r\n  host: REDIS_HOST,\r\n  port: REDIS_PORT,\r\n  auth_pass: REDIS_AUTH_KEY,\r\n  return_buffers: true,\r\n}) : null;\r\n\r\nconst redisClient = canRedis ? createRedisClient({\r\n  host: REDIS_HOST,\r\n  port: REDIS_PORT,\r\n  auth_pass: REDIS_AUTH_KEY,\r\n}) : null;\r\n\r\nexport function getRedisItem(id) {\r\n  return new Promise((resolve, reject) => {\r\n    redisClient.get(id, (error, res) => error ? reject(error) : resolve(res));\r\n  });\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/core/redisClient.js","/* eslint no-console: 0, no-throw-literal: 0 */\r\nimport express from 'express';\r\nimport cors from 'cors';\r\nimport redisAdapter from 'socket.io-redis';\r\nimport {\r\n  subClient,\r\n  pubClient,\r\n  getRedisItem,\r\n  canRedis,\r\n} from 'core/redisClient';\r\n\r\nconst app = express();\r\nconst server = require('http').Server(app); // eslint-disable-line\r\nserver.listen(process.env.PORT || __PORT__, () => {\r\n  const { port } = server.address();\r\n  console.log(`The server is listening at http://localhost:${port}`);\r\n  if (__DEV__) {\r\n    console.log('__DEV_START__');\r\n  }\r\n});\r\n\r\napp.use(cors());\r\napp.get('*', (req, res) => {\r\n  res.status(200).send('Hello World');\r\n});\r\n\r\nexport default server;\r\n\r\n// it can be replaced DB\r\nconst channels = {};\r\nconst users = {};\r\n\r\nconst io = require('socket.io')(server);\r\n\r\nif (canRedis) {\r\n  io.adapter(redisAdapter({\r\n    pubClient,\r\n    subClient,\r\n  }));\r\n}\r\n\r\nio.on('connection', socket => {\r\n  const id = socket.client.id;\r\n\r\n  function use(route, callback) {\r\n    socket.on(route, (...args) => {\r\n      try {\r\n        callback(...args);\r\n      } catch (error) {\r\n        if (typeof(error) === 'string') {\r\n          socket.emit(`${route} error`, {\r\n            type: route,\r\n            message: error,\r\n          });\r\n        } else {\r\n          console.log(error);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  // authorize user\r\n  use('authenticate user', async ({ token, username }) => {\r\n    if (canRedis) {\r\n      const userInfo = await getRedisItem(token);\r\n      if (!userInfo) throw 'Invalid token';\r\n    }\r\n    const user = users[id] = {\r\n      id,\r\n      username,\r\n      channels: [],\r\n    };\r\n    socket.emit('authorized', {\r\n      user,\r\n    });\r\n  });\r\n\r\n  // join channel\r\n  use('join channel', ({ link }) => {\r\n    const user = users[id];\r\n    if (!user) throw 'you should be authorized';\r\n    if (user.channels.indexOf(link) !== -1) throw 'already connected';\r\n    if (!channels[link]) {\r\n      channels[link] = {\r\n        link,\r\n        allUsers: 0,\r\n      };\r\n    }\r\n    const channel = channels[link];\r\n    user.channels.push(link);\r\n    channel.allUsers++;\r\n    socket.join(link);\r\n    socket.broadcast.to(link).emit('user joined', {\r\n      channel,\r\n      user,\r\n    });\r\n    socket.emit('channel connected', {\r\n      channel,\r\n    });\r\n  });\r\n\r\n  // leave channel\r\n  use('leave channel', ({ link }) => {\r\n    const user = users[id];\r\n    if (!user) throw 'you should be authorized';\r\n    if (user.channels.indexOf(link) === -1) throw 'not in connected';\r\n    const channel = channels[link];\r\n    if (!channel) throw 'the channel does not exist';\r\n    user.channels.splice(user.channels.indexOf(link), 1);\r\n    socket.emit('channel disconnected', { channel });\r\n    socket.broadcast.to(link).emit('user left', { channel, user });\r\n    socket.leave(link);\r\n    channel.allUsers -= 1;\r\n    if (!channel.allUsers) {\r\n      delete channels[link];\r\n    }\r\n  });\r\n\r\n  // send new message to users in the channel\r\n  use('new message', ({ link, content }) => {\r\n    const user = users[id];\r\n    if (!user) throw 'you should be authorized';\r\n    const channel = channels[link];\r\n    if (!channel) throw 'the channel does not exist';\r\n    if (user.channels.indexOf(link) === -1) throw 'you did not join the channel';\r\n    const message = {\r\n      author: id,\r\n      username: user.username,\r\n      content,\r\n    };\r\n    io.sockets.to(link).emit('new message', {\r\n      message,\r\n      channel,\r\n    });\r\n  });\r\n\r\n  // disconnected\r\n  socket.on('disconnect', () => {\r\n    const user = users[id];\r\n    if (!user) {\r\n      return;\r\n    }\r\n    user.channels.forEach(link => {\r\n      const channel = channels[link];\r\n      socket.broadcast.to(link).emit('user left', { channel, user });\r\n      channel.allUsers -= 1;\r\n      if (!channel.allUsers) {\r\n        delete channels[link];\r\n      }\r\n    });\r\n  });\r\n});\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/server.js","module.exports = require(\"babel-polyfill\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-polyfill\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"cors\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"cors\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"express\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"express\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"http\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"http\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"redis\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"redis\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"socket.io\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"socket.io\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"socket.io-redis\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"socket.io-redis\"\n// module id = 10\n// module chunks = 0"],"sourceRoot":""}
